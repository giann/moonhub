local a=js.global;local b=a.document;local c=require("moonview.helpers")local d=c.q;local e=c.qall;local f=require("etlua")local g=require("hump.signal")local h=function(i)local j={template=i and i.template or nil,compiled=nil,target=i and i.target or nil,model=i and i.model or{},events=i and i.events or{},setTemplate=function(self,k)if self.template~=k then self.template=k;self.compiled=nil end end,render=function(self)local k=self.template and d(self.template)or nil;k=k and k.textContent or nil;local l=self.target and d(self.target)or nil;if l and k then if not self.compiled then self.compiled=f.compile(k)end;self:beforeRender()l.innerHTML=self.compiled(rawget(self.model,"model"))self:afterRender()self:registerEvents()end end,registerEvents=function(self)for m,n in pairs(self.events)do local o,p=m:match("(%w+)(.+)")local q=e(p)for r=1,#q do q[r]:addEventListener(o,function(s,t)return n(self,s,t)end)end end end,beforeRender=i and i.beforeRender or function()end,afterRender=i and i.afterRender or function()end}g.register("model-update",function(u,v,w)if u==j.model then j:render()end end)return j end;local x=function(i)return setmetatable({model=i},{__newindex=function(self,v,w)rawget(self,"model")[v]=w;g.emit("model-update",self,v,w)end,__index=function(self,v)return rawget(self,"model")[v]end,__len=function(self)return#rawget(self,"model")end})end;local y=function(z)return setmetatable({collection=z},{__newindex=function(self,v,w)local A=rawget(self.collection,v)~=nil;local B={"collection-update"}if A then if w==nil then table.insert(B,"collection-remove")end else if w~=nil then table.insert(B,"collection-add")end end;rawget(self,"collection")[v]=w;for C,D in ipairs(B)do g.emit(D,self,v,w)end end,__index=function(self,v)return rawget(self,"collection")[v]end,__len=function(self)return#rawget(self,"collection")end})end;return{View=h,Model=x,Collection=y}
